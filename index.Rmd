---
title: "Wrap it up"
output: 
  flexdashboard::flex_dashboard:
    
---

```{r setup, include=FALSE, results='hide'}
library(flexdashboard)
library(spotifyr)
library(tidyverse)
library(plotly)
library(ggrepel)
library(compmus)
library(purrr)
```

```{r, results='hide'}
march_2022 <- get_playlist_audio_features("", "5GcVdmYmopYD63VA3Jlrdg")
april_2022 <- get_playlist_audio_features("", "0D8lpYsC42ARjmUeiJRPbX")
may_2022 <- get_playlist_audio_features("", "10gcAHZbtdKmPEsq2sfDXV")
june_2022 <- get_playlist_audio_features("", "60KrNVuCol1SmUIUl0afWe")
july_2022 <- get_playlist_audio_features("", "2s7WBylfTXxMoK43n0yQH4")
august_2022 <- get_playlist_audio_features("", "1iXOgnOcpvoiETQW4yJ2iX")
september_2022 <- get_playlist_audio_features("", "5eqF7aFUfXKmNN9yliTlXL")
october_2022 <- get_playlist_audio_features("", "483hVg9hepeZL7JjFXIpMz")
november_2022 <- get_playlist_audio_features("", "6zYA9NzOPb9nYjV21KNKsD")
december_2022 <- get_playlist_audio_features("", "5P8jALdx9bXJQMTR0dO5Xd")

full_2022 <- bind_rows(
    march_2022 |> mutate(year="2022", month="march"),
    april_2022 |> mutate(year="2022", month="april"),
    may_2022 |> mutate(year="2022", month="may"),
    june_2022 |> mutate(year="2022", month="june"),
    july_2022 |> mutate(year="2022", month="july"),
    august_2022 |> mutate(year="2022", month="august"),
    september_2022 |> mutate(year="2022", month="september"),
    october_2022 |> mutate(year="2022", month="october"),
    november_2022 |> mutate(year="2022", month="november"),
    december_2022 |> mutate(year="2022", month="december")
)

full_2022
```

What a poser.
===================================== 


Inputs {.sidebar}
-------------------------------------


Wrapped Attributes {.tabset}
-------------------------------------

### Introduction 

```{r, results='hide'}
full_2022 |>                    
  mutate(
    mode = ifelse(mode == 0, "Minor", "Major")
  ) |>
  ggplot(                     
    aes(
      x = valence,
      y = energy,
      size = loudness,
      colour = mode
    )
  ) +
  geom_point() +              
  geom_rug(linewidth = 0.1) + 
  facet_wrap(~ year) +    
  scale_x_continuous(         
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),   
    minor_breaks = NULL       
  ) +
  scale_y_continuous(         
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(        
    type = "qual",            
    palette = "Paired"        
  ) +
  scale_size_continuous(      
    trans = "exp",            
    guide = "none"            
  ) +
  theme_light() +             
  labs(                       
    x = "Valence",
    y = "Energy",
    colour = "Month",
    size = "Loudness"
  ) 
```
### March


Interesting songs
===================================== 


Inputs {.sidebar}
-------------------------------------


Wrapped Attributes {.tabset}
-------------------------------------


### Introduction 

```{r}
bodysnatchers <-
  get_tidy_audio_analysis("4pWIwnnqx8k01fuF95UMIg") |> # Change URI.
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

bodysnatchers |>
  compmus_self_similarity(timbre, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```
```{r}
# bodysnatchers |>
#   compmus_gather_timbre() |>
#   ggplot(
#     aes(
#       x = start + duration / 2,
#       width = duration,
#       y = basis,
#       fill = value
#     )
#   ) +
#   geom_tile() +
#   labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
#   scale_fill_viridis_c() +                              
#   theme_classic()
```

